# 客户端单周发版下的多分支自动化管理与实践

[原文](https://tech.meituan.com/2019/01/10/traffic-git-branch-management.html)

## 背景

单周迭代的外部原因 - 需求方希望尽早地看到结果，并给予及时反馈。

优点：

1. 更快地验证产品创意是否符合预期
2. 更灵活地上线节奏
3. 更早地修复线上 Bug

所以 之前的每四周发一版改为每周都有发版。

> （旧）三周迭代指的是 2 周开发+1 周半测试，依赖固定的排期和测试时间，如果错过排期，则需要等待至少 20 天方可跟着下个版本迭代发布，线上验证产品效果的时间偏长。具体示例描述如下：

> ![迭代](https://p0.meituan.net/travelcube/bae2546099903ee08fe59ba2bbfd491a109932.png)

> （新）单周版本迭代指一周一发版，单周迭代版本排期、测试不再依赖固定时间节点，需求开发并测试完成，就可以搭乘最近一周的发版“小火车”，跟版发布直接上线。对于一般需求而言，这将会大大缩短迭代时间。

## 业务方研发人员的痛点

> 在之前按月发版的迭代节奏下，基本上所有的需求都属于串行开发，每个版本的开发流程比较固定。从“评审-开发-提测-灰度-上线”各个环节都处于一个固定的时间点来顺序执行，开发人力资源的协调方式也相对简单。

> 全面推进单周发版之后，并不能把所有需求压缩到 5 天之内开发完成，而是会存在大量的并行开发的场景，之前的固定时间节点全部被打破，由固定周期变成了动态化调配，这给业务方的需求管理和研发人员人力管理都带来了指数式复杂度的提升。**一旦进入并行开发，需求之间会产生冲突和依赖关系，版本代码也会随之产生冲突和依赖，这也大大提高了开发过程中的分支管理成本**。

> 下面描述了几种典型的单周发版带来的问题：

> - 业务需求开发周期不固定，会存在大量的多版本、多需求并行开发

> 在单周发版的前提下，都要面临跨版本开发，意味着多个版本多个需求会同步并行开发，这给业务方的分支管理带来了极大的挑战。

> - 业务方架构复杂，仓库依赖多，**单周发版分支创建合并维护成本大**

> 多仓库频繁发版分支代码存在安全风险，容易漏合代码，冲掉线上代码。

> - 业务线自身的公共基础库需求变动频繁。也需要具备单周发版的能力

> 这些公共组件的业务变化频繁，公共基础仓库变化的同时，可能会对使用组件的业务产生影响，需要同步的升级发版

## 单周发版分支管理解决方案

> 针对上面提出的问题，交通客户端团队通过**技术培训、流程优化、关键点检测、自动化处理**等方式保证分支代码的安全。

> 针对这些问题，我们推出了如下分支管理结构。总的来说，就是废除之前作为开发分支的 Develop 分支，建立对应的 Release 发版分支，每个版本打包从 Release 分支直接打包；同时 Stage 分支不再承担打包职责，而是作为一个主干分支实时同步所有已发布上线的功能，Stage 分支更像一个“母体”，孵化出 Release 分支和其它 Feature 分支；当 Release 分支测试通过、并且发版上线之后，再合入到 Stage 分支，此时所有正在开发中的其它分支都需要同步 Stage 分支的最新代码，保证下一个即将发布的版本的功能代码的完整性。

> ![交通业务单周发版分支管理模型示意图](https://p0.meituan.net/travelcube/b327725ce3bf7563e4c913e15d332ae6161042.png)

> 下面是简化的流程图，每个版本都有自己的生命周期：

> ![交通业务单周发版分支生命周期](https://p0.meituan.net/travelcube/b1dadad18836fad6c83782b5c2d0231115275.png)

> 1. 从 Stage 创建一个 Release 分支；
> 2. 进入开发阶段；
> 3. 如果 Stage 分支有变化，同步 Stage 分支；
> 4. 打包测试；
> 5. 测试通过，发布线上；
> 6. 发布线上之后，合回 Stage 分支。

> 为了适应单周发版，新的开发流程也引入了很多新的挑战。例如下图所示的一个 Branch 分支中涉及的六个关键点：**创建分支、合入主干、主干变化通知、Merge 主干变化、检测主干同步、未同步拦截**，除了这些还要考虑多仓库同步操作的问题，还有热修复版本的管理方式的问题。能否把这些关键节点合理的规范和把控起来，是我们当前应对多分支并行开发的主要难点：

> ![交通业务单周发版关键节点](https://p0.meituan.net/travelcube/8488e2815a69fda0c95490d2581e350f100796.png)

> 如何更高效的解决这些问题呢？

> 1. 创建分支 Release 分支如何创建，何时创建，分支命名规范定义如何约束？

> 创建 Release 分支，本质上是从 Stage 新建一个分支，当前提前一个周期创建新的发版分支，例如在 10.1.1 版本 Release 后，创建 10.1.3 版本的分支，此时 10.1.2 版本处于开发测试阶段。业务方所有的分支命名和平台的分支命名保持一致，采用 Release/x.x.x 的格式，但同时需要升级成为即将发布的 Release 版本号，例如 10.1.3。  
> 对此，我们采用了 Jenkins 的方式，需要建立一个 Jenkins Job, 基本原理就是通过命令行的方式进行 Branch 的创建，然后通过 Job 管理，批处理建立所有仓库的 Release 分支，这样就收敛了 Branch 的创建，即采用统一的命名规范，并且同时升级版本号。这就解决了创建分支的难点，实现了自动化创建分支，并且实现了规范化命名。

> 2.  如何知道 Stage 分支有变化，变化后需要做什么，不做会怎样？

> 这里做了三个措施来确保各个分支和 Stage 是保持同步的：一个通知，一个警告，一次拦截。这三个步骤解决主干变化通知、检测主干同步、未同步拦截的问题。

> **一个通知**：具体路径如下，建立了一个内部推送公众账号和一个 Jenkins 监听 Job，当所有交通业务仓库 Stage 分支有代码改动，通知所有对应的开发人员，该仓库有代码变化，请及时合入。

> **一次警告**：本地开发过程中，每次提交代码到远端仓库时，会触发一个 Stage 分支代码同步检测的脚本，如果发现未同步，会通过内部通讯系统通知提交者存在未同步主分支问题。但这里目前并不做强制拦截，保证分支代码开发的整体流畅性。

> **最终拦截**：在开发分支打包的过程中强制拦截，最终功能代码上线还是需要打包操作。在打包操作时统一收口，由于之前打包也是在 Jenkins 上来完成的，这里我们也是通过在打包 Jenkins 上接入了分支合并检测的插件，这样每次打包时会再次检测和主分支的同步情况。如果发现未同步则打包失败，确保每次发版都包含当前线上已有代码的功能，防止新版本丢失功能。

> 3.  如何合并分支，如何保证无漏合？

> 和上面提到的第一个如何创建分支的问题类似，通过 Jenkins Job 来进行批量操作，可以一键创建所有分支的 Pull Request；在每个版本发版之前，统一进行一次打包，合入美团的主分支，防止多个仓库有漏合的情况。

> 4. 公共基础库版本策略？

> 公共基础和业务分支保持同样的策略，通过批处理脚本同时建立分支，合并分支，监听分支变化，需要注意的是，每次版本升级，公共基础库也需要同步的打包，并且强制业务库升级。不然，如果基础仓库存在接口变动，有的业务升级了，有的业务没升级，最终会导致无法合入主分支，进而无法打出 App 包。

> 5.  热修复的版本管理策略？

> 热修复确实是一种非常规的处理方式。从原则上来讲，热修复需要在对应的 Release 分支上进行修改，然后把修改合入 Stage 分支，同时需要同步到其它正在开发的分支。实际的处理需要根据具体情况来分析，是否需要对线上多个版本热修复。如果多版本都要修复就不能再合入 Stage 分支，否则会导致 Stage 分支冲突，如果把 Stage 分支合入需要热修复的其它分支，会把线上当前最新代码带入历史旧版本，会导致版本兼容性问题。最终执行起来可能还是对热修复版本进行单独处理，不一定要进行 Stage 主分支的同步，热修复的版本管理成本会比较高，更多的需要人工介入。

## 未来展望

> 目前整体的分支发版流程已经基本完成，现在已经稳定运行了 10 个小版本，同时没有出现因为分支管理问题而引发的线上问题。

> 不过，当前整体流程的自动化程度还有待提高，每周需要人工去触发，很多代码合并过程中的冲突问题还需要人工去解决。未来我们希望能够自动化地根据平台的版本号自动创建分支，并且对于一些简单的冲突问题拥有自动化的处理能力。随着单周发版的不断成熟，未来对于持续交付能力也将不断提升，发版节奏可以不限于单周，一周两版或是更快的发版节奏也成为一种新的可能。

## 思考 🤔

单周迭代节奏快，需求可能会被打散到各个版本中，存在多个版本并行开发的情况。这对需求管理和开发人力管理都是一个挑战。这篇文章把重心放到了分支管理上。多版本并行开发，多仓库协作开发会产生多个关联分支。这些分支在隶属上和依赖上如果不通过一套方法来统一管理，就会造成混乱。

文章中提到的策略是，先确立一个基准分支 Stage。从 Stage 分支上拉取出用于打包上线的 Release 分支，和用于开发新功能的 Feature 分支。Release 分支作为所有可上线需求的容器，Feature 分支在开发完成后合并到最近的 Release 分支上。在 Release 分支测试完毕，打包上线后并合并到 Stage 分支。

Release 分支需要积极地同步 Stage 分支的变化，而 Feature 分支也要积极地校准想要合并入的 Release 分支。

在这样的开发流程中有几个关键点，创建分支、合入主分支、主分支变化通知、合并主分支变化、检查主分支同步、未同步拦截。还要注意热修复版本的管理。

为了高效地解决这些问题，可以结合一些自动化工具。

1. 在分支的创建和命名规范上，可以通过自动化脚本根据版本号统一创建各个仓库的分支，并且分支命名保持一致，如 release/x.x.x。
2. 在 Stage 分支有变化时，通过内部的 IM 工具**通知**对应的开发人员。当有代码提交到远程分支时，通过脚本做同步检测。如果没有和 Stage 分支同步过，就发出**警告**。在开发分支打包的时候，如果发现未和主分支同步，则进行**拦截**，打包失败。
3. 创建 pr 也通过脚本来批量操作，防止有漏合的情况。
4. 在公共基础库的升级上尤其需要注意，因为有大量业务依赖。
5. 热修复的分支需要从对应的 Release 分支上拉取，修改完后合入 Release 分支。至于是否还需要和 Stage 分支同步，需要具体问题具体分析。
